<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Target Locations Map</title>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #map-container {
            flex: 1;
            position: relative;
            min-height: 200px;
            height: 60%;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }

        #resize-handle {
            height: 10px;
            background: #e0e0e0;
            cursor: row-resize;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        #resize-handle::before {
            content: "";
            width: 30px;
            height: 4px;
            background: #999;
            border-radius: 2px;
        }

        #resize-handle:hover {
            background: #ccc;
        }

        #kanban-container {
            flex: 1;
            min-height: 200px;
            height: 40%;
            overflow: hidden;
        }

        #kanban-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .legend {
            padding: 10px;
            background: white;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 24px;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .filter-control {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .parent-checkbox {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .child-checkboxes {
            margin-left: 20px;
        }
        .indeterminate {
            position: relative;
        }
        .indeterminate::after {
            content: "âˆ’";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }
        .map-marker {
            -webkit-text-stroke: 1px black;
            text-stroke: 1px black;
            filter: drop-shadow(0px 0px 1px rgba(0,0,0,0.5));
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div class="filter-control">
            <h4>Filters</h4>
            <div id="statusFilters">
                <h5>Athletic Centers</h5>
                <label>
                    <input type="checkbox" id="athletic_centers" checked>
                    All Athletic Centers
                </label>
                <div class="sub-filters">
                    <label><input type="checkbox" class="status-filter" data-status="not contacted" checked> Not Contacted</label>
                    <label><input type="checkbox" class="status-filter" data-status="initial contact" checked> Initial Contact</label>
                    <label><input type="checkbox" class="status-filter" data-status="in discussion" checked> In Discussion</label>
                    <label><input type="checkbox" class="status-filter" data-status="partnership agreed" checked> Partnership Agreed</label>
                    <label><input type="checkbox" class="status-filter" data-status="partnership active" checked> Partnership Active</label>
                    <label><input type="checkbox" class="status-filter" data-status="not interested" checked> Not Interested</label>
                </div>
            </div>
        </div>
    </div>
    <div id="resize-handle"></div>
    <div id="kanban-container">
        <iframe id="kanban-frame" src="kanban.html"></iframe>
    </div>

    <script>
        // Initialize the map
        var map = L.map('map').setView([39.8283, -98.5795], 4);
        
        // Base map layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19,
            minZoom: 3
        }).addTo(map);

        // Define colors
        const statusColors = {
            'not contacted': '#808080',      // Gray
            'initial contact': '#FFA500',    // Orange
            'in discussion': '#4169E1',      // Royal Blue
            'partnership agreed': '#32CD32',  // Lime Green
            'partnership active': '#228B22',  // Forest Green
            'not interested': '#FF0000'      // Red
        };

        // Function to get marker size based on zoom level
        function getMarkerSize(zoomLevel) {
            if (zoomLevel >= 15) return 48;
            if (zoomLevel >= 12) return 36;
            if (zoomLevel >= 9) return 28;
            return 24;
        }

        // Create layer groups
        let targetMarkers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            iconCreateFunction: function(cluster) {
                const childCount = cluster.getChildCount();
                
                let c = ' marker-cluster-';
                if (childCount < 10) {
                    c += 'small';
                } else if (childCount < 100) {
                    c += 'medium';
                } else {
                    c += 'large';
                }

                // Get dominant status color
                const markers = cluster.getAllChildMarkers();
                const statusCounts = markers.reduce((counts, marker) => {
                    const status = marker.targetData.status;
                    counts[status] = (counts[status] || 0) + 1;
                    return counts;
                }, {});

                const dominantStatus = Object.entries(statusCounts)
                    .sort((a, b) => b[1] - a[1])[0][0];

                const color = statusColors[dominantStatus] || '#666';

                return new L.DivIcon({
                    html: '<div style="background-color: ' + color + '"><span>' + childCount + '</span></div>',
                    className: 'marker-cluster' + c,
                    iconSize: new L.Point(40, 40)
                });
            }
        });

        // Fetch data
        Promise.all([
            fetch('/api/targets').then(response => response.json())
        ]).then(([targetsData]) => {
            // Store targets globally
            targets = targetsData;
            console.log("Loaded targets:", targets.length);
            console.log("Sample target:", targets[0]);

            // Process targets
            targets.forEach(target => {
                if (target.latitude && target.longitude) {
                    const status = target.status;
                    const size = getMarkerSize(map.getZoom());
                    const faSize = Math.floor(size * 1.5);

                    const marker = L.marker([target.latitude, target.longitude], {
                        icon: L.divIcon({
                            html: `<i class="fas fa-map-marker-alt" style="font-size: ${faSize}px; color: ${getColorForStatus(status)}"></i>`,
                            className: 'custom-marker',
                            iconSize: [size, size],
                            iconAnchor: [size/2, size],
                            popupAnchor: [0, -size]
                        })
                    });

                    // Add popup
                    marker.bindPopup(`
                        <strong>${target.organization}</strong><br>
                        Status: ${status}<br>
                        ${target.address || ''}<br>
                        ${target.notes ? '<br>Notes: ' + target.notes : ''}
                    `);

                    // Store target data with marker
                    marker.targetData = target;
                    targetMarkers.addLayer(marker);
                }
            });

            // Add markers to map
            map.addLayer(targetMarkers);

            // Function to update parent checkbox state
            function updateParentCheckbox(parentId, childrenSelector) {
                const parent = document.getElementById(parentId);
                if (!parent) return;

                const children = document.querySelectorAll(childrenSelector);
                const checkedCount = Array.from(children).filter(child => child.checked).length;
                
                if (checkedCount === 0) {
                    parent.checked = false;
                    parent.indeterminate = false;
                } else if (checkedCount === children.length) {
                    parent.checked = true;
                    parent.indeterminate = false;
                } else {
                    parent.checked = false;
                    parent.indeterminate = true;
                }
            }

            // Function to toggle all children based on parent state
            function toggleChildren(parentId, childrenSelector) {
                const parent = document.getElementById(parentId);
                if (!parent) return;

                const children = document.querySelectorAll(childrenSelector);
                children.forEach(child => {
                    child.checked = parent.checked;
                });
            }

            // Initial filter state
            updateParentCheckbox('athletic_centers', '#statusFilters input[type="checkbox"]');
            
            // Set up filter event listeners
            document.querySelectorAll('#statusFilters input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.id === 'athletic_centers') {
                        toggleChildren('athletic_centers', '#statusFilters input.status-filter');
                    } else {
                        updateParentCheckbox('athletic_centers', '#statusFilters input[type="checkbox"]');
                    }
                    updateFilters();
                });
            });
        });

        function updateFilters() {
            targetMarkers.clearLayers();

            targets.forEach(target => {
                if (target.latitude && target.longitude) {
                    const status = target.status;
                    const statusCheckbox = document.querySelector(`input.status-filter[data-status="${status}"]`);
                    
                    if (statusCheckbox && statusCheckbox.checked) {
                        const size = getMarkerSize(map.getZoom());
                        const faSize = Math.floor(size * 1.5);

                        const marker = L.marker([target.latitude, target.longitude], {
                            icon: L.divIcon({
                                html: `<i class="fas fa-map-marker-alt" style="font-size: ${faSize}px; color: ${getColorForStatus(status)}"></i>`,
                                className: 'custom-marker',
                                iconSize: [size, size],
                                iconAnchor: [size/2, size],
                                popupAnchor: [0, -size]
                            })
                        });

                        marker.bindPopup(`
                            <strong>${target.organization}</strong><br>
                            Status: ${status}<br>
                            ${target.address || ''}<br>
                            ${target.notes ? '<br>Notes: ' + target.notes : ''}
                        `);

                        marker.targetData = target;
                        targetMarkers.addLayer(marker);
                    }
                }
            });
        }

        function getColorForStatus(status) {
            return statusColors[status] || '#000';
        }

        // Add resize handle functionality
        const mapContainer = document.getElementById('map-container');
        const resizeHandle = document.getElementById('resize-handle');
        const kanbanContainer = document.getElementById('kanban-container');
        let isDragging = false;

        resizeHandle.addEventListener('mousedown', function(e) {
            isDragging = true;
            document.body.style.cursor = 'row-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;

            const containerHeight = window.innerHeight;
            const y = Math.min(Math.max(200, e.clientY), containerHeight - 200);
            const mapHeight = y;
            const kanbanHeight = containerHeight - y - 10; // 10px for resize handle

            mapContainer.style.height = mapHeight + 'px';
            mapContainer.style.flex = 'none';
            kanbanContainer.style.height = kanbanHeight + 'px';
            kanbanContainer.style.flex = 'none';

            // Trigger map resize event to ensure proper rendering
            map.invalidateSize();
        });

        document.addEventListener('mouseup', function() {
            isDragging = false;
            document.body.style.cursor = '';
        });

        // Ensure map renders correctly in resized container
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });

        // Listen for messages from the kanban iframe
        window.addEventListener('message', function(event) {
            if (event.data.type === 'updateMapPin') {
                const target = event.data.target;
                let markerFound = false;
                
                // Find and update the marker for this target
                targetMarkers.getLayers().forEach(marker => {
                    const popup = marker.getPopup();
                    if (popup) {
                        const content = popup.getContent();
                        // Check if this is the marker for our target
                        if (content.includes(`<strong>${target.organization}</strong>`)) {
                            markerFound = true;
                            // Update marker color based on new status
                            const status = target.status;
                            const currentZoom = map.getZoom();
                            const size = getMarkerSize(currentZoom);
                            const faSize = Math.floor(size * 1.5);
                            
                            const newIcon = L.divIcon({
                                html: `<i class="fas fa-map-marker-alt" style="font-size: ${faSize}px; color: ${getColorForStatus(status)}"></i>`,
                                className: 'custom-marker',
                                iconSize: [size, size],
                                iconAnchor: [size/2, size],
                                popupAnchor: [0, -size]
                            });
                            
                            marker.setIcon(newIcon);
                            
                            // Update popup content
                            const newPopupContent = `
                                <strong>${target.organization}</strong><br>
                                Status: ${status}<br>
                                ${target.address || ''}<br>
                                ${target.notes ? '<br>Notes: ' + target.notes : ''}
                            `;
                            marker.setPopupContent(newPopupContent);
                            
                            // Update marker status property
                            marker.options.status = status;
                            
                            // If the marker's status is not in the selected statuses, remove it
                            const selectedStatuses = Array.from(document.querySelectorAll('#statusFilters input.status-filter')).filter(checkbox => checkbox.checked).map(checkbox => checkbox.getAttribute('data-status'));
                            
                            if (!selectedStatuses.includes(status)) {
                                targetMarkers.removeLayer(marker);
                            }
                        }
                    }
                });

                // If marker wasn't found (might have been filtered out), create a new one
                if (!markerFound && target.latitude && target.longitude) {
                    const status = target.status;
                    const currentZoom = map.getZoom();
                    const size = getMarkerSize(currentZoom);
                    const faSize = Math.floor(size * 1.5);
                    
                    const marker = L.marker([target.latitude, target.longitude], {
                        icon: L.divIcon({
                            html: `<i class="fas fa-map-marker-alt" style="font-size: ${faSize}px; color: ${getColorForStatus(status)}"></i>`,
                            className: 'custom-marker',
                            iconSize: [size, size],
                            iconAnchor: [size/2, size],
                            popupAnchor: [0, -size]
                        })
                    });

                    const popupContent = `
                        <strong>${target.organization}</strong><br>
                        Status: ${status}<br>
                        ${target.address || ''}<br>
                        ${target.notes ? '<br>Notes: ' + target.notes : ''}
                    `;
                    
                    marker.bindPopup(popupContent);
                    
                    // Store target data with marker
                    marker.targetData = target;
                    
                    // Only add the marker if its status is currently selected
                    const selectedStatuses = Array.from(document.querySelectorAll('#statusFilters input.status-filter')).filter(checkbox => checkbox.checked).map(checkbox => checkbox.getAttribute('data-status'));
                    
                    if (selectedStatuses.includes(status)) {
                        targetMarkers.addLayer(marker);
                    }
                }
            }
        });
    </script>
</body>
</html>
